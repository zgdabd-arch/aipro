
/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model where all user-related data
 * is stored in subcollections under that user's unique document. Access is controlled entirely by
 * matching the authenticated user's ID (`request.auth.uid`) with the user ID in the document path.
 * This ensures users can only ever access their own data.
 *
 * Data Structure: All data is organized hierarchically under the `/users/{userId}` path. This includes
 * the user's own document, their student profiles, and the associated study plans and progress reports.
 * For example: /users/{userId}/studentProfiles/{profileId}/studyPlans/{planId}.
 *
 * Key Security Decisions:
 * - User Enumeration Blocked: Listing the top-level `/users` collection is explicitly denied to
 *   prevent malicious actors from discovering all users of the application.
 * - Path-Based Security: All authorization decisions are made based on the `{userId}` wildcard in
 *   the document path. This is highly performant as it avoids extra database reads (`get()` calls).
 * - Self-Creation of User Document: A newly signed-up user is permitted to create their own
 *   user document at `/users/{their-own-uid}`.
 * - Prototyping Flexibility: Data shape and type validation are intentionally omitted to allow
 *   for rapid development. Security focuses strictly on authorization (who can access what), not
 *   on data schema validation.
 *
 * Denormalization for Authorization: The data structure itself is a form of denormalization for
 * authorization. By nesting all of a user's data under a path containing their UID, we avoid
 * the need to store and check an `ownerId` field on every single document for authorization.
 *
 * Structural Segregation: The architecture perfectly segregates each user's private data into
 * their own document tree, preventing any possibility of data leakage between users at the
 * collection level. There are no public collections in this model.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for concise and reusable logic
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Controls access to a user's own root document.
     * @path /users/{userId}
     * @allow (create) An authenticated user creating their own user document for the first time.
     * @deny (list) Any user, authenticated or not, trying to list all documents in the `/users` collection.
     * @principle Enforces self-creation and strict ownership, while preventing user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Block user enumeration for security
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Secures a user's student profile documents.
     * @path /users/{userId}/studentProfiles/{studentProfileId}
     * @allow (create) An authenticated user creating a student profile for themselves under their own path.
     * @deny (get) A user trying to read another user's student profile data.
     * @principle Restricts all access to a user's own data tree using path-based ownership.
     */
    match /users/{userId}/studentProfiles/{studentProfileId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Secures the study plans associated with a student's profile.
     * @path /users/{userId}/studentProfiles/{studentProfileId}/studyPlans/{studyPlanId}
     * @allow (update) The owner of the profile updating one of their study plans.
     * @deny (create) A different user trying to add a study plan to someone else's profile.
     * @principle Inherits ownership from the top-level `{userId}` in the path.
     */
    match /users/{userId}/studentProfiles/{studentProfileId}/studyPlans/{studyPlanId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Secures the progress reports for a specific study plan.
     * @path /users/{userId}/studentProfiles/{studentProfileId}/studyPlans/{studyPlanId}/progress/{progressId}
     * @allow (delete) The user deleting a progress entry for one of their own study plans.
     * @deny (list) An unauthenticated user attempting to list progress entries.
     * @principle Enforces strict, inherited ownership for deeply nested private data.
     */
    match /users/{userId}/studentProfiles/{studentProfileId}/studyPlans/{studyPlanId}/progress/{progressId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }
  }
}
